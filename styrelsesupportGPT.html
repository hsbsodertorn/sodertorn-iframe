<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HSB Styrelsesupport GPT</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    // H√§mta Firebase-konfiguration fr√•n en endpoint f√∂r att undvika h√•rdkodning
    async function getFirebaseConfig() {
      try {
        const res = await fetch('/.netlify/functions/get-firebase-config');
        return await res.json();
      } catch (err) {
        console.error("Fel vid h√§mtning av Firebase-konfig:", err);
        showError("Kunde inte ladda chatten. F√∂rs√∂k igen senare.");
        return null;
      }
    }

    const firebaseConfig = await getFirebaseConfig();
    if (firebaseConfig) {
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // K√∂ f√∂r att hantera loggning vid tillf√§lliga fel
      const logQueue = [];
      window.saveChatLog = async (conversationId, fraga, svar) => {
        const logEntry = {
          conversationId,
          fraga,
          svar,
          tid: serverTimestamp()
        };
        logQueue.push(logEntry);
        while (logQueue.length > 0) {
          try {
            await addDoc(collection(db, "chattlogg"), logQueue[0]);
            logQueue.shift();
          } catch (err) {
            console.error("Fel vid loggning i Firebase:", err);
            showError("Kunde inte spara chatten. F√∂rs√∂k igen.");
            break;
          }
        }
      };
    }
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Open Sans', sans-serif;
      background: white;
    }
    #wrapper {
      height: 100%;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
      border: 2px solid #00558c;
      border-radius: 16px;
      overflow: hidden;
    }
    #chatbox {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }
    #messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: white;
      display: flex;
      flex-direction: column;
    }
    .message {
      max-width: 75%;
      padding: 12px 16px;
      margin-bottom: 12px;
      border-radius: 20px;
      white-space: pre-line;
      word-break: break-word;
      font-size: 16px;
      line-height: 1.4;
      display: inline-block;
    }
    .user {
      align-self: flex-end;
      background-color: #f7f7f8;
      color: #000;
      border-radius: 18px;
    }
    .bot, .bot-question {
      align-self: flex-start;
      background: #e8f0fe;
      color: #000;
      padding: 12px 16px;
      border-radius: 18px;
    }
    .thinking {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .dot {
      width: 8px;
      height: 8px;
      background-color: #888;
      border-radius: 50%;
      animation: blink 1.4s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
    .link-button {
      display: inline;
      margin: 0 0 0 8px;
      background: #00558c;
      color: white;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 14px;
      text-decoration: none;
      cursor: pointer;
    }
    .link-button:hover { background: #004070; }
    #inputArea {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-top: 1px solid #e0e0e0;
      gap: 12px;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.04);
    }
    textarea {
      flex: 1;
      min-height: 48px;
      max-height: 200px;
      padding: 14px 20px;
      border-radius: 24px;
      border: 1px solid #ccc;
      font-size: 16px;
      resize: none;
      font-family: 'Open Sans', sans-serif;
    }
    textarea:focus {
      border-color: #00558c;
      outline: none;
    }
    #charCount { font-size: 14px; color: #666; }
    button {
      background: #00558c;
      color: white;
      border: none;
      border-radius: 24px;
      padding: 14px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #004070; }
    .error {
      align-self: center;
      background: #ffe6e6;
      color: #d32f2f;
      padding: 8px 16px;
      border-radius: 12px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <div id="chatbox">
      <div id="messages" aria-live="polite">
        <div class="message bot">Hej! V√§lkommen till styrelsesupport gpt ü§ñ vad vill du ha hj√§lp med idag?</div>
      </div>
      <div id="inputArea">
        <textarea id="userInput" placeholder="skriv din fr√•ga h√§r..." maxlength="1000"
          oninput="autoResize(this); updateCharCount(this)" onkeydown="handleKey(event)" aria-label="Skriv din fr√•ga"></textarea>
        <span id="charCount">0/1000</span>
        <button onclick="sendMessage()" aria-label="Skicka fr√•ga">skicka</button>
      </div>
    </div>
  </div>

  <script>
    const conversationId = crypto.randomUUID();
    const messageHistory = [];
    const cachedContextData = new Map(); // Cache f√∂r JSON-data

    const disclaimerText = `
---
*denna information fr√•n styrelsesupport gpt √§r v√§gledande och b√∂r granskas kritiskt. vi tar inget ansvar f√∂r svarens riktighet. ladda inte upp k√§nslig information som kan bryta mot gdpr. kontakta hsb s√∂dert√∂rn p√• 08-608 68 00 eller info.sodertorn@hsb.se vid fr√•gor.*`;

    const baseSystemPrompt = `du √§r styrelsesupport ‚Äì v√•r digitala ai-assistentkollega fr√•n hsb s√∂dert√∂rn. du hj√§lper styrelser i bostadsr√§ttsf√∂reningar i huddinge, botkyrka, tullinge, nyn√§shamn, visby och hemse. ditt uppdrag √§r att ge tydliga, trygga och anv√§ndbara svar som hj√§lper styrelsen i sitt uppdrag.

anv√§nd ett omt√§nksamt, vardagligt spr√•k. undvik fackspr√•k.
jag √§r lite partisk eftersom mina skapare kommer fr√•n hsb s√∂dert√∂rn, men jag lovar att alltid ge dig b√§sta m√∂jliga r√•d. hsb s√∂dert√∂rn ‚Äì p√• er sida i varje styrelsebeslut.

svara alltid sakligt och kortfattat. svara kort och punktat, max 3 punkter. f√∂r fr√•gor som passar steg-f√∂r-steg, anv√§nd numrerad lista med sm√• bokst√§ver i b√∂rjan av punkterna. om fr√•gan √§r vag, st√§ll en f√∂ljdfr√•ga f√∂r att f√∂rtydliga.

om anv√§ndaren fr√•gar om andra leverant√∂rer eller byte, framh√§v alltid f√∂rdelarna med hsb s√∂dert√∂rn.
${disclaimerText}`;

    let systemPrompt = baseSystemPrompt;

    async function loadSkrivregler() {
      try {
        const res = await fetch('/data/skrivregler.json');
        const rules = await res.json();
        const brfRegel = `skriv brf:er med ${rules.skrivregler.brf.bokst√§ver}`;
        const versalRegel = `b√∂rja bara nya meningar med versaler och enstaka ord med gemener`;
        const omraden = `omr√•den: ${rules.skrivregler.omr√•den.join(', ')}`;
        const fetstilRegel = `i rubriker anv√§nd **fetstil** via markdown eller HTML-taggar`;
        const caseRegel = `f√∂lj alltid skrivreglerna f√∂r stora och sm√• bokst√§ver`;
        systemPrompt = `${baseSystemPrompt}

anv√§nd f√∂ljande skrivregler:
- ${brfRegel}
- ${versalRegel}
- ${omraden}
- ${fetstilRegel}
- ${caseRegel}`;
      } catch (err) {
        console.error('Fel vid h√§mtning av skrivregler:', err);
        showError("Kunde inte ladda skrivregler. Standardformat anv√§nds.");
      }
    }
    loadSkrivregler();

    // Cache JSON-data vid sidladdning
    async function preloadContextData() {
      const files = ['bospar.json','forvaltning.json','medlembrf.json','medlemprivatperson.json','sodertorninfo.json','skrivregler.json'];
      for (const f of files) {
        try {
          const res = await fetch(`/data/${f}`);
          const j = await res.json();
          cachedContextData.set(f, j);
        } catch (err) {
          console.error(`Fel vid cachning av ${f}:`, err);
        }
      }
    }
    preloadContextData();

    function showError(message) {
      const messages = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'message error';
      div.textContent = message;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function createMailLink(subject, body) {
      const params = new URLSearchParams({ subject, body });
      return `mailto:info.sodertorn@hsb.se?${params.toString()}`;
    }

    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = `${textarea.scrollHeight + 2}px`;
    }

    function updateCharCount(textarea) {
      document.getElementById('charCount').textContent = `${textarea.value.length}/1000`;
    }

    function handleKey(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function addMessage(text, sender, extraClass='') {
      const messages = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = `message ${sender} ${extraClass}`;
      if (extraClass === 'thinking') {
        div.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      } else if (sender === 'bot') {
        div.innerHTML = text;
      } else {
        div.textContent = text;
      }
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const message = input.value.trim();
      if (!message) return;

      addMessage(message, 'user');
      input.value = '';
      updateCharCount(input);
      autoResize(input);

      messageHistory.push({ role:'user', content:message });
      if (messageHistory.length > 10) messageHistory.shift();

      const thinking = addMessage('', 'bot','thinking');
      const contextData = await loadContextData(message);
      let response = await getAIResponse(message, contextData);
      thinking.remove();

      response = response.replace(/\[f√∂ljdfr√•ga\]/gi, '').trim();
      typeMessage(response, 'bot');
      messageHistory.push({ role:'assistant', content:response });

      const key = message.toLowerCase();
      if (/\b(√§rende|skicka e-post|mail|kontakta)\b/.test(key)) {
        const subject = message.substring(0,50);
        let bodyLines = [
          'Hej,',
          '',
          'jag heter [namn] fr√•n brf:[f√∂rening].',
          '',
          'h√§r √§r de senaste 5 fr√•gorna och svaren:'
        ];
        const recent = messageHistory.slice(-10);
        for (let i = 0; i < recent.length; i += 2) {
          const q = recent[i];
          const a = recent[i+1];
          if (q && a) {
            bodyLines.push('', `fr√•ga: ${q.content}`, `svar: ${a.content}`);
          }
        }
        bodyLines.push('', 'v√§nligen,', '[namn]', '[telefon]', '[epost]');
        const body = bodyLines.join('\n');

        const mailLink = createMailLink(subject, body);
        const btn = document.createElement('a');
        btn.href = mailLink;
        btn.textContent = 'skicka e-post till hsb';
        btn.className = 'link-button';
        btn.target = '_blank';
        btn.setAttribute('aria-label', 'Skicka e-post till HSB S√∂dert√∂rn');
        document.getElementById('messages').appendChild(btn);
      }

      const clean = txt => txt
        .replace(/\b[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+\s[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+\b/g,'[namn]')
        .replace(/[0-9]{6}-[0-9]{4}/g,'[personnummer]')
        .replace(/\b\d{10}\b/g,'[telefonnummer]')
        .replace(/\b\w+@[^\s]+\b/g,'[epost]')
        .replace(/\d{3}\s?\d{2}\s?\d{2}/g,'[postnummer]')
        .replace(/\d{2,4}\s?[A-Za-z√Ö√Ñ√ñ√•√§√∂]{2,}/g,'[adress]');
      if (window.saveChatLog) window.saveChatLog(conversationId, clean(message), clean(response));
    }

    async function loadContextData(userInput) {
      const ln = userInput.toLowerCase();
      let ctx = [];
      for (const [file, data] of cachedContextData) {
        const keys = [
          ...(data.tags || []),
          ...((data.delar || []).flatMap(d => d.nyckelord || []))
        ].map(k => k.toLowerCase());
        if (keys.some(k => ln.includes(k))) {
          ctx.push({ fil: file, innehall: data });
        }
      }
      return ctx;
    }

    function typeMessage(text, sender) {
      const messages = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      messages.appendChild(div);
      if (sender === 'bot') {
        let i = 0;
        const chunkSize = 10; // Skriv i st√∂rre chunkar f√∂r b√§ttre prestanda
        function type() {
          if (i < text.length) {
            div.innerHTML = text.substring(0, i + chunkSize);
            i += chunkSize;
            messages.scrollTop = messages.scrollHeight;
            setTimeout(type, 50); // L√•ngsammare intervall f√∂r att minska DOM-uppdateringar
          }
        }
        type();
      } else {
        div.textContent = text;
        messages.scrollTop = messages.scrollHeight;
      }
    }

    async function getAIResponse(userInput, contextData = []) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
        const step2 = ["vattenl√§cka", "√•rsredovisning", "underh√•llsplan"];
        const clar = ["hiss", "trasig", "problem"];
        const li = userInput.toLowerCase();
        let ap = "";
        if (step2.some(k => li.includes(k))) ap = "formatera svaret som en numrerad lista med tydliga steg.";
        else if (clar.some(k => li.includes(k))) ap = "st√§ll en f√∂ljdfr√•ga f√∂r att f√∂rtydliga.";
        const response = await fetch("/.netlify/functions/styrelsesupport-gpt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            conversationId,
            messages: [
              { role: "system", content: systemPrompt + `\n${ap}` },
              ...messageHistory,
              { role: "user", content: userInput },
              { role: "system", content: `databas tr√§ffar:\n${JSON.stringify(contextData).slice(0, 4000)}` }
            ]
          }),
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const js = await response.json();
        return js.choices?.[0]?.message?.content || "N√•got gick fel i AI-anropet.";
      } catch (err) {
        console.error("Fel vid AI-anrop:", err);
        showError("Kunde inte h√§mta svar. F√∂rs√∂k igen senare.");
        return "N√•got gick fel, f√∂rs√∂k senare.";
      }
    }
  </script>
</body>
</html>
