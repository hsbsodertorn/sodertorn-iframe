<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HSB Styrelsesupport GPT</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f0f0; }
    #chatbox {
      width: 100%;
      max-width: 400px;
      height: 600px;
      border: 2px solid #00558c;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      margin: 40px auto;
      background: white;
    }
    #messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #f5f5f5;
    }
    .message {
      margin-bottom: 12px;
      white-space: pre-line;
    }
    .user { text-align: right; color: #00558c; }
    .bot { text-align: left; color: #333; }
    .bot a { color: #00558c; text-decoration: underline; }
    .disclaimer {
      font-style: italic;
      font-size: 0.85em;
      border-top: 1px solid #ccc;
      margin-top: 8px;
      padding-top: 8px;
    }
    #inputArea {
      display: flex;
      padding: 12px;
      background: #fff;
      border-top: 1px solid #ccc;
    }
    input {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-right: 8px;
    }
    button {
      background: #00558c;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      cursor: pointer;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAmG3ZuxR8A6WNjPUwa3EDA79rLjwYqS_4",
      authDomain: "hsbsodertorn-1e7a5.firebaseapp.com",
      projectId: "hsbsodertorn-1e7a5",
      storageBucket: "hsbsodertorn-1e7a5.appspot.com",
      messagingSenderId: "34372808211",
      appId: "1:34372808211:web:85e0c908917ff232ce59e6",
      measurementId: "G-LTWGETNT98"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    window.saveChatLog = async (conversationId, fraga, svar) => {
      try {
        await addDoc(collection(db, "chattlogg"), {
          conversationId,
          fraga,
          svar,
          tid: serverTimestamp()
        });
      } catch (err) {
        console.error("Fel vid loggning i Firebase:", err);
      }
    };
  </script>
</head>
<body>

<div id="chatbox">
  <div id="messages">
    <div class="message bot">Hej! V칛lkommen till Styrelsesupport GPT 游뱄 Vad vill du ha hj칛lp med idag?</div>
  </div>
  <div id="inputArea">
    <input type="text" id="userInput" placeholder="Skriv din fr친ga h칛r..." onkeydown="handleKey(event)" />
    <button onclick="sendMessage()">Skicka</button>
  </div>
</div>

<script>
  const conversationId = crypto.randomUUID();
  const messageHistory = [];

  function handleKey(event) {
    if (event.key === "Enter") sendMessage();
  }

  async function sendMessage() {
    const input = document.getElementById("userInput");
    const message = input.value.trim();
    if (!message) return;

    addMessage(message, "user");
    input.value = "";
    messageHistory.push({ role: "user", content: message });

    const response = await getAIResponse(message);
    messageHistory.push({ role: "assistant", content: response });
    typeMessage(response, "bot");

    if (window.saveChatLog) {
      window.saveChatLog(conversationId, message, response);
    }
  }

  function addMessage(text, sender) {
    const messages = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = "message " + sender;
    div.innerHTML = convertLinks(text) + getDisclaimer(sender);
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function typeMessage(text, sender) {
    const messages = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = "message " + sender;
    messages.appendChild(div);

    let i = 0;
    function typeChar() {
      if (i < text.length) {
        div.innerHTML = convertLinks(text.substring(0, ++i)) + getDisclaimer(sender);
        messages.scrollTop = messages.scrollHeight;
        setTimeout(typeChar, 12);
      }
    }
    typeChar();
  }

  function convertLinks(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, function(url) {
      return `<a href="${url}" target="_blank">${url}</a>`;
    });
  }

  function getDisclaimer(sender) {
    if (sender !== "bot") return "";
    return `
      <div class="disclaimer">
        Denna information fr친n Styrelsesupport GPT 칛r v칛gledande och b칬r granskas kritiskt. Vi tar inget ansvar f칬r svarens riktighet. Ladda inte upp k칛nslig information som kan bryta mot GDPR. Kontakta HSB S칬dert칬rn p친 08-608 68 00 eller info.sodertorn@hsb.se vid fr친gor.
      </div>
    `;
  }

  async function getAIResponse(userInput) {
    const lowerInput = userInput.toLowerCase();

    if (lowerInput.includes("felanm칛lan")) {
      return `Du g칬r enklast en felanm칛lan via:\n游녤 https://hsb.se/sodertorn/kontakt/felanmalan\nVid akuta 칛renden (t.ex. v칛rmestopp eller vattenl칛cka) ring jouren: 08-608 68 00.`;
    }

    if (lowerInput.includes("kontakt") || lowerInput.includes("mejla")) {
      return `Kontakta oss direkt:\n游 08-608 68 00\n游닎 info.sodertorn@hsb.se\nVill du att jag visar kontaktformul칛ret?`;
    }

    if (lowerInput.includes("kronor") || lowerInput.includes("sek") || lowerInput.includes("personnummer")) {
      return `Jag kan tyv칛rr inte ge ut kostnadsuppskattningar eller hantera personuppgifter h칛r. Kontakta oss ist칛llet s친 hj칛lper vi dig personligen:\n游 08-608 68 00\n游닎 info.sodertorn@hsb.se\nTips: Ha g칛rna information om 칛rendet redo. Vill du ha en checklista?`;
    }

    try {
      const dataFiles = [
        "forvaltning.json",
        "medlembrf.json",
        "medlemprivatperson.json",
        "bospar.json",
        "storingar.json"
      ];

      for (const file of dataFiles) {
        const res = await fetch(`data/${file}`);
        const data = await res.json();

        if (data.delar && Array.isArray(data.delar)) {
          const match = data.delar.find(d =>
            d.nyckelord?.some(n => lowerInput.includes(n.toLowerCase()))
          );
          if (match) {
            return `${match.beskrivning}\nVill du veta mer om detta?\nL칛s mer: ${match.lank}`;
          }
        }

        if (data.tags && data.tags.some(tag => lowerInput.includes(tag.toLowerCase()))) {
          return `${data.sammanfattning}\nVill du att jag visar n친gra exempel p친 vad det kan handla om?`;
        }
      }

      return "Jag hittade tyv칛rr inget svar i v친r databas p친 det du fr친gade. Vill du kontakta HSB S칬dert칬rn direkt?\n游 08-608 68 00\n游닎 info.sodertorn@hsb.se";
    } catch (error) {
      console.error("Fel vid databass칬kning:", error);
      return "Jag f칬rs칬kte s칬ka i v친r databas men n친got gick fel. F칬rs칬k igen eller kontakta kundservice.";
    }
  }
</script>

</body>
</html>
