<!DOCTYPE html>
<html lang="sv">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>HSB Styrelsesupport GPT</title>
Â  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
Â  Â  // BehÃ¶ver updateDoc fÃ¶r att kunna markera en rating som given pÃ¥ UI-elementet (valfritt)
Â  Â  import { getFirestore, collection, addDoc, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";


Â  Â  // HÃ¥rdkodad Firebase-konfiguration som en tillfÃ¤llig lÃ¶sning
Â  Â  // **BYT UT "DIN_FIREBASE_API_KEY" MOT DIN RIKTIGA API-NYCKEL**
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "DIN_FIREBASE_API_KEY", // <--- BYT UT!
Â  Â  Â  authDomain: "hsbsodertorn-1e7a5.firebaseapp.com",
Â  Â  Â  projectId: "hsbsodertorn-1e7a5",
Â  Â  Â  storageBucket: "hsbsodertorn-1e7a5.appspot.com",
Â  Â  Â  messagingSenderId: "34372808211",
Â  Â  Â  appId: "1:34372808211:web:85e0c908917ff232ce59e6",
Â  Â  Â  measurementId: "G-LTWGETNT98"
Â  Â  };

Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getFirestore(app);

Â  Â  // KÃ¶ fÃ¶r att hantera loggning vid tillfÃ¤lliga fel
    // Modifierad fÃ¶r att inkludera clientTimestamp i loggen
Â  Â  const logQueue = [];
Â  Â  window.saveChatLog = async (conversationId, fraga, svar, clientTimestamp) => {
Â  Â  Â  const logEntry = {
Â  Â  Â  Â  conversationId,
Â  Â  Â  Â  fraga,
Â  Â  Â  Â  svar,
Â  Â  Â  Â  tid: serverTimestamp(),
        clientTimestamp: clientTimestamp // LÃ¤gg till tidsstÃ¤mpel frÃ¥n klienten
Â  Â  Â  };
Â  Â  Â  logQueue.push(logEntry);
Â  Â  Â  while (logQueue.length > 0) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // Lagrar varje frÃ¥ga/svar i samlingen 'chattlogg'
Â  Â  Â  Â  Â  await addDoc(collection(db, "chattlogg"), logQueue[0]);
Â  Â  Â  Â  Â  logQueue.shift();
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error("Fel vid loggning i Firebase:", err);
Â  Â  Â  Â  Â  showError("Kunde inte spara chatten. FÃ¶rsÃ¶k igen.");
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  };

Â  Â  // NY Funktion fÃ¶r att spara ett betyg fÃ¶r ett SPECIFIKT meddelande
Â  Â  window.saveMessageRating = async (conversationId, aiMessageClientTimestamp, ratingValue) => {
Â  Â  Â  try {
Â  Â  Â  Â  await addDoc(collection(db, "messageRatings"), {
Â  Â  Â  Â  Â  conversationId: conversationId,
          // AnvÃ¤nd clientTimestamp fÃ¶r att lÃ¤nka till rÃ¤tt meddelande i chattloggen
Â  Â  Â  Â  Â  aiMessageClientTimestamp: aiMessageClientTimestamp,
Â  Â  Â  Â  Â  rating: ratingValue, // 'up' eller 'down'
Â  Â  Â  Â  Â  timestamp: serverTimestamp() // NÃ¤r betyget gavs
Â  Â  Â  Â  });
Â  Â  Â  Â  console.log("Betyg sparat fÃ¶r meddelande (conv:", conversationId, "ts:", aiMessageClientTimestamp, "):", ratingValue);
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Fel vid sparning av meddelandebetyg i Firebase:", err);
Â  Â  Â  Â  // Hantera fel, t.ex. visa ett litet felmeddelande vid ikonerna
Â  Â  Â  }
Â  Â  };

Â  </script>

Â  <style>
Â  Â  *, *::before, *::after { box-sizing: border-box; }
Â  Â  html, body {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  height: 100%;
Â  Â  Â  font-family: 'Open Sans', sans-serif;
Â  Â  Â  background: white;
Â  Â  }
Â  Â  #wrapper {
Â  Â  Â  height: 100%;
Â  Â  Â  width: 100%;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  background: white;
Â  Â  Â  border: 2px solid #00558c;
Â  Â  Â  border-radius: 16px;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  #chatbox {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  }
Â  Â  #messages {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 16px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  background: white;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â  .message {
Â  Â  Â  max-width: 75%;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  white-space: pre-line;
Â  Â  Â  word-break: break-word;
Â  Â  Â  font-size: 16px;
Â  Â  Â  line-height: 1.4;
Â  Â  Â  display: inline-block; /* Viktigt fÃ¶r att rating-ikonerna ska hamna rÃ¤tt bredvid */
Â  Â  }
Â  Â  .user {
Â  Â  Â  align-self: flex-end;
Â  Â  Â  background-color: #f7f7f8;
Â  Â  Â  color: #000;
Â  Â  Â  border-radius: 18px;
Â  Â  }
Â  Â  .bot, .bot-question {
Â  Â  Â  align-self: flex-start;
Â  Â  Â  background: #e8f0fe;
Â  Â  Â  color: #000;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  border-radius: 18px;
Â  Â  Â  margin-right: 40px; /* Ge utrymme fÃ¶r rating-ikonerna */
Â  Â  }

    /* NY CSS FÃ–R RATING-IKONER */
    .message-container {
        display: flex; /* AnvÃ¤nd flexbox fÃ¶r att justera meddelande och ikoner */
        align-items: flex-end; /* Justera ikonerna i botten av meddelandet */
        align-self: flex-start; /* BehÃ¥ll 'bot' placering */
        margin-bottom: 12px; /* Samma marginal som .message */
    }

    .message-container.user {
         align-self: flex-end; /* Ã…terstÃ¤ll fÃ¶r anvÃ¤ndarmeddelanden */
         justify-content: flex-end; /* AnvÃ¤ndarmeddelanden till hÃ¶ger */
    }
     .message-container .message.user {
        margin-right: 0; /* Ta bort extra marginal fÃ¶r anvÃ¤ndarmeddelanden */
     }


    .message-rating {
        display: flex;
        flex-direction: column; /* Ikoner under varandra */
        align-items: center;
        margin-left: 8px; /* Mellanslag mellan meddelande och ikoner */
        opacity: 0; /* DÃ¶lj initialt */
        transition: opacity 0.2s ease-in-out;
    }

     /* Visa ikoner nÃ¤r musen Ã¤r Ã¶ver meddelandet (eller dess container) */
    .message-container:hover .message-rating {
        opacity: 1;
    }

    .rating-icon {
        width: 20px; /* Storlek pÃ¥ ikonen */
        height: 20px;
        cursor: pointer;
        margin: 2px 0; /* Litet utrymme mellan ikonerna */
        fill: #888; /* GrÃ¥ fÃ¤rg */
        transition: fill 0.2s;
    }

    .rating-icon:hover {
        fill: #000; /* MÃ¶rkare vid hover */
    }

    .rating-icon.selected {
        fill: #00558c; /* HSB BlÃ¥ nÃ¤r vald */
    }
     .rating-icon.selected.up {
        fill: green; /* GrÃ¶n fÃ¶r tumme upp (kan justeras) */
     }
      .rating-icon.selected.down {
        fill: red; /* RÃ¶d fÃ¶r tumme ner (kan justeras) */
     }

    .rating-icon.disabled {
        pointer-events: none; /* GÃ¥r inte att klicka pÃ¥ */
        opacity: 0.5;
    }


Â  Â  .thinking {
Â  Â  Â  display: inline-flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 4px;
Â  Â  }
Â  Â  .dot {
Â  Â  Â  width: 8px;
Â  Â  Â  height: 8px;
Â  Â  Â  background-color: #888;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  animation: blink 1.4s infinite;
Â  Â  }
Â  Â  .dot:nth-child(2) { animation-delay: 0.2s; }
Â  Â  .dot:nth-child(3) { animation-delay: 0.4s; }
Â  Â  @keyframes blink {
Â  Â  Â  0%, 80%, 100% { opacity: 0; }
Â  Â  Â  40% { opacity: 1; }
Â  Â  }
Â  Â  .link-button {
Â  Â  Â  display: inline;
Â  Â  Â  margin: 0 0 0 8px;
Â  Â  Â  background: #00558c;
Â  Â  Â  color: white;
Â  Â  Â  padding: 6px 12px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  text-decoration: none;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background 0.2s;
Â  Â  }
Â  Â  .link-button:hover { background: #004070; }
Â  Â  #inputArea {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  border-top: 1px solid #e0e0e0;
Â  Â  Â  gap: 12px;
Â  Â  Â  box-shadow: 0 -2px 4px rgba(0,0,0,0.04);
Â  Â  }
Â  Â  textarea {
Â  Â  Â  flex: 1;
Â  Â  Â  min-height: 48px;
Â  Â  Â  max-height: 200px;
Â  Â  Â  padding: 14px 20px;
Â  Â  Â  border-radius: 24px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  font-size: 16px;
Â  Â  Â  resize: none;
Â  Â  Â  font-family: 'Open Sans', sans-serif;
Â  Â  }
Â  Â  textarea:focus {
Â  Â  Â  border-color: #00558c;
Â  Â  Â  outline: none;
Â  Â  }
Â  Â  #charCount { font-size: 14px; color: #666; }
Â  Â  button {
Â  Â  Â  background: #00558c;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 24px;
Â  Â  Â  padding: 14px 20px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background 0.2s;
Â  Â  }
Â  Â  button:hover { background: #004070; }
Â  Â  .error {
Â  Â  Â  align-self: center;
Â  Â  Â  background: #ffe6e6;
Â  Â  Â  color: #d32f2f;
Â  Â  Â  padding: 8px 16px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  margin-bottom: 12px;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div id="wrapper">
Â  Â  <div id="chatbox">
Â  Â  Â  <div id="messages" aria-live="polite">
Â  Â  Â  Â  <div class="message bot">Hej! VÃ¤lkommen till styrelsesupport gpt ðŸ¤– Vad vill du ha hjÃ¤lp med idag?</div>
          Â  Â  Â  </div>

      Â  Â  Â  <div id="inputArea">
Â  Â  Â  Â  <textarea id="userInput" placeholder="skriv din frÃ¥ga hÃ¤r..." maxlength="1000"
Â  Â  Â  Â  Â  oninput="autoResize(this); updateCharCount(this)" onkeydown="handleKey(event)" aria-label="Skriv din frÃ¥ga"></textarea>
Â  Â  Â  Â  <span id="charCount">0/1000</span>
Â  Â  Â  Â  <button onclick="sendMessage()" aria-label="Skicka frÃ¥ga">skicka</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // Denna ID Ã¤r unik per sidladdning/konversation
Â  Â  const conversationId = crypto.randomUUID();
Â  Â  const messageHistory = [];
Â  Â  const cachedContextData = new Map(); // Cache fÃ¶r JSON-data

Â  Â  const disclaimerText = `
---
*denna information frÃ¥n styrelsesupport gpt Ã¤r vÃ¤gledande och bÃ¶r granskas kritiskt. vi tar inget ansvar fÃ¶r svarens riktighet. ladda inte upp kÃ¤nslig information som kan bryta mot gdpr. kontakta hsb sÃ¶dertÃ¶rn pÃ¥ 08-608 68 00 eller info.sodertorn@hsb.se vid frÃ¥gor.*`;

Â  Â  const baseSystemPrompt = `du Ã¤r styrelsesupport â€“ vÃ¥r digitala ai-assistentkollega frÃ¥n hsb sÃ¶dertÃ¶rn. du hjÃ¤lper styrelser i bostadsrÃ¤ttsfÃ¶reningar i huddinge, botkyrka, tullinge, nynÃ¤shamn, visby och hemse. ditt uppdrag Ã¤r att ge tydliga, trygga och anvÃ¤ndbara svar som hjÃ¤lper styrelsen i sitt uppdrag.

anvÃ¤nd ett omtÃ¤nksamt, vardagligt sprÃ¥k. undvik facksprÃ¥k.
jag Ã¤r lite partisk eftersom mina skapare kommer frÃ¥n hsb sÃ¶dertÃ¶rn, men jag lovar att alltid ge dig bÃ¤sta mÃ¶jliga rÃ¥d. hsb sÃ¶dertÃ¶rn â€“ pÃ¥ er sida i varje styrelsebeslut.

svara alltid sakligt och kortfattat. svara kort och punktat, max 3 punkter. fÃ¶r frÃ¥gor som passar steg-fÃ¶r-steg, anvÃ¤nd numrerad lista med smÃ¥ bokstÃ¤ver i bÃ¶rjan av punkterna. om frÃ¥gan Ã¤r vag, stÃ¤ll en fÃ¶ljdfrÃ¥ga fÃ¶r att fÃ¶rtydliga.

om anvÃ¤ndaren frÃ¥gar om andra leverantÃ¶rer eller byte, framhÃ¤v alltid fÃ¶rdelarna med hsb sÃ¶dertÃ¶rn.
${disclaimerText}`;

Â  Â  let systemPrompt = baseSystemPrompt;

Â  Â  async function loadSkrivregler() {
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch('/data/skrivregler.json');
Â  Â  Â  Â  const rules = await res.json();
Â  Â  Â  Â  const brfRegel = `skriv brf:er med ${rules.skrivregler.brf.bokstÃ¤ver}`;
Â  Â  Â  Â  const versalRegel = `bÃ¶rja bara nya meningar med versaler och enstaka ord med gemener`;
Â  Â  Â  Â  const omraden = `omrÃ¥den: ${rules.skrivregler.omrÃ¥den.join(', ')}`;
Â  Â  Â  Â  const fetstilRegel = `i rubriker anvÃ¤nd **fetstil** via markdown eller HTML-taggar`;
Â  Â  Â  Â  const caseRegel = `fÃ¶lj alltid skrivreglerna fÃ¶r stora och smÃ¥ bokstÃ¤ver`;
Â  Â  Â  Â  systemPrompt = `${baseSystemPrompt}

anvÃ¤nd fÃ¶ljande skrivregler:
- ${brfRegel}
- ${versalRegel}
- ${omraden}
- ${fetstilRegel}
- ${caseRegel}`;
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Fel vid hÃ¤mtning av skrivregler:', err);
Â  Â  Â  Â  showError("Kunde inte ladda skrivregler. Standardformat anvÃ¤nds.");
Â  Â  Â  }
Â  Â  }
Â  Â  loadSkrivregler();

Â  Â  // Cache JSON-data vid sidladdning
Â  Â  async function preloadContextData() {
Â  Â  Â  const files = ['bospar.json','forvaltning.json','medlembrf.json','medlemprivatperson.json','sodertorninfo.json','skrivregler.json'];
Â  Â  Â  for (const f of files) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const res = await fetch(`/data/${f}`);
Â  Â  Â  Â  Â  const j = await res.json();
Â  Â  Â  Â  Â  cachedContextData.set(f, j);
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error(`Fel vid cachning av ${f}:`, err);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  preloadContextData();

Â  Â  function showError(message) {
Â  Â  Â  const messages = document.getElementById('messages');
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'message error';
Â  Â  Â  div.textContent = message;
Â  Â  Â  messages.appendChild(div);
Â  Â  Â  messages.scrollTop = messages.scrollHeight;
Â  Â  }

Â  Â  function createMailLink(subject, body) {
Â  Â  Â  const params = new URLSearchParams({ subject, body });
Â  Â  Â  return `mailto:info.sodertorn@hsb.se?${params.toString()}`;
Â  Â  }

Â  Â  function autoResize(textarea) {
Â  Â  Â  textarea.style.height = 'auto';
Â  Â  Â  textarea.style.height = `${textarea.scrollHeight + 2}px`;
Â  Â  }

Â  Â  function updateCharCount(textarea) {
Â  Â  Â  document.getElementById('charCount').textContent = `${textarea.value.length}/1000`;
Â  Â  }

Â  Â  function handleKey(event) {
Â  Â  Â  if (event.key === 'Enter' && !event.shiftKey) {
Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  sendMessage();
Â  Â  Â  }
Â  Â  }

    // Modifierad addMessage fÃ¶r att hantera meddelande-containers och rating-ikoner
Â  Â  function addMessage(text, sender, extraClass='', aiMessageClientTimestamp = null) {
Â  Â  Â  const messages = document.getElementById('messages');

      // Skapa en container fÃ¶r meddelandebubblan OCH rating-ikonerna
      const containerDiv = document.createElement('div');
      containerDiv.className = `message-container ${sender}`;
       // LÃ¤gg till tidsstÃ¤mpel som data-attribut fÃ¶r att lÃ¤nka rating
      if(aiMessageClientTimestamp) {
          containerDiv.dataset.aiTimestamp = aiMessageClientTimestamp;
      }
       containerDiv.dataset.conversationId = conversationId; // LÃ¤gg till conversationId

Â  Â  Â  const messageDiv = document.createElement('div');
Â  Â  Â  messageDiv.className = `message ${sender} ${extraClass}`;

Â  Â  Â  if (extraClass === 'thinking') {
Â  Â  Â  Â  messageDiv.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
          containerDiv.appendChild(messageDiv); // Thinking har inga ikoner initialt
Â  Â  Â  } else {
          // FÃ¶r riktiga meddelanden, skapa meddelandebubblan
           if (sender === 'bot') {
Â  Â  Â  Â  Â  Â  messageDiv.innerHTML = text; // AnvÃ¤nd innerHTML fÃ¶r bot-svar fÃ¶r att tillÃ¥ta HTML/fetstil
Â  Â  Â  Â  Â  } else { // User message
Â  Â  Â  Â  Â  Â  messageDiv.textContent = text;
Â  Â  Â  Â  Â  }

          containerDiv.appendChild(messageDiv);

          // NYTT: LÃ¤gg till rating-ikonerna EFTER bot-meddelanden
          if (sender === 'bot') {
             const ratingDiv = document.createElement('div');
             ratingDiv.className = 'message-rating';
             ratingDiv.innerHTML = `
                 <svg class="rating-icon up" data-rating="up" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Tumme upp</title><path d="M14.63,21H5.37A2.38,2.38,0,0,1,3,18.63V12.51a.5.5,0,0,1,.15-.36L7.11,8.49a2.38,2.38,0,0,1,1.69-.7h.16a.5.5,0,0,1,.46.3l1.57,3.15a.5.5,0,0,0,.32.28H16a2.4,2.4,0,0,0,2.35-2l.21-1.05a.5.5,0,0,0-.48-.56H16a.5.5,0,0,1-.5-.5.5.5,0,0,0-.5-.5H14a.5.5,0,0,1-.5-.5.5.5,0,0,0-.5-.5H12a.5.5,0,0,1-.5-.5.5.5,0,0,0-.5-.5H9.91A4.38,4.38,0,0,0,6.72,6.31L3.08,9.94a1.36,1.36,0,0,0-.05.15V4.37A2.38,2.38,0,0,1,5.37,2h9.26A2.38,2.38,0,0,1,17,4.37V8.09A.5.5,0,0,0,17.5,8.59H20A2,2,0,0,1,22,10.59v6A2,2,0,0,1,20,18.59H18.82a3.47,3.47,0,0,0-.33.19l-1.8,1.44A2.4,2.4,0,0,1,14.63,21Z"/> Tumme upp SVG
                 <svg class="rating-icon down" data-rating="down" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Tumme ner</title><path d="M9.37,3H18.63A2.38,2.38,0,0,1,21,5.37v6.12a.5.5,0,0,1-.15.36L16.89,15.51a2.38,2.38,0,0,1-1.69.7h-.16a.5.5,0,0,1-.46-.3L13,12.86a.5.5,0,0,0-.32-.28H8a2.4,2.4,0,0,0-2.35,2l-.21,1.05a.5.5,0,0,0,.48.56H8a.5.5,0,0,1,.5.5.5.5,0,0,0,.5.5H10a.5.5,0,0,1,.5.5.5.5,0,0,0,.5.5H12a.5.5,0,0,1,.5.5.5.5,0,0,0,.5.5h.09A4.38,4.38,0,0,0,17.28,17.69l3.64-3.63a1.36,1.36,0,0,0,.05-.15V19.63A2.38,2.38,0,0,1,18.63,22H9.37A2.38,2.38,0,0,1,7,19.63V16.09a.5.5,0,0,0-.5-.59H4A2,2,0,0,1,2,13.59v-6A2,2,0,0,1,4,5.59H5.18a3.47,3.47,0,0,0,.33-.19l1.8-1.44A2.4,2.4,0,0,1,9.37,3Z"/> Tumme ner SVG
             `;
             containerDiv.appendChild(ratingDiv);
          }
      }


Â  Â  Â  messages.appendChild(containerDiv);
Â  Â  Â  messages.scrollTop = messages.scrollHeight;
Â  Â  Â  return messageDiv; // Returnera meddelande-bubblan fÃ¶r typeMessage
Â  Â  }

Â  Â  // LÃ¤gg till enkel regex-lÃ¶sning fÃ¶r fetstil
Â  Â  function renderBold(text) {
Â  Â  Â  return text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
Â  Â  }

Â  Â  // Funktion fÃ¶r att tillÃ¤mpa skrivregler pÃ¥ AI-svar
Â  Â  function applySkrivregler(text) {
Â  Â  Â  // BÃ¶rja meningar med versaler, enstaka ord med gemener
Â  Â  Â  return text.replace(/(^|\.\s+)([a-zÃ¥Ã¤Ã¶])/g, (match, p1, p2) => p1 + p2.toUpperCase());
Â  Â  }


Â  Â  async function sendMessage() {
Â  Â  Â  const input = document.getElementById('userInput');
Â  Â  Â  const message = input.value.trim();
Â  Â  Â  if (!message) return;

Â  Â  Â  addMessage(message, 'user');
Â  Â  Â  input.value = '';
Â  Â  Â  updateCharCount(input);
Â  Â  Â  autoResize(input);

Â  Â  Â  messageHistory.push({ role:'user', content:message });
Â  Â  Â  // BehÃ¥ll historiken till en rimlig lÃ¤ngd fÃ¶r kontext
Â  Â  Â  while (messageHistory.length > 10) messageHistory.shift();

Â  Â  Â  const thinking = addMessage('', 'bot','thinking');
Â  Â  Â  const contextData = await loadContextData(message);
Â  Â  Â  let response = await getAIResponse(message, contextData);
Â  Â  Â  thinking.remove();

Â  Â  Â  response = response.replace(/\[fÃ¶ljdfrÃ¥ga\]/gi, '').trim();
Â  Â  Â  response = applySkrivregler(response); // TillÃ¤mpa skrivregler
Â  Â  Â  response = renderBold(response);Â  Â  Â  // Rendera fetstil

      // NYTT: Spara tidsstÃ¤mpel fÃ¶r detta specifika AI-svar innan loggning
      const aiResponseClientTimestamp = new Date().getTime();

      // Skriv ut AI-svaret med typeMessage OCH skicka med tidsstÃ¤mpeln
Â  Â  Â  typeMessage(response, 'bot', null, aiResponseClientTimestamp); // Skickar med tidsstÃ¤mpel

Â  Â  Â  messageHistory.push({ role:'assistant', content:response });
      // BehÃ¥ll historiken till en rimlig lÃ¤ngd fÃ¶r kontext
      while (messageHistory.length > 10) messageHistory.shift();


Â  Â  Â  const key = message.toLowerCase();
Â  Â  Â  if (/\b(Ã¤rende|skicka e-post|mail|kontakta)\b/.test(key)) {
Â  Â  Â  Â  const subject = message.substring(0,50);
Â  Â  Â  Â  let bodyLines = [
Â  Â  Â  Â  Â  'Hej,',
Â  Â  Â  Â  Â  '',
Â  Â  Â  Â  Â  'jag heter [namn] frÃ¥n brf:[fÃ¶rening].',
Â  Â  Â  Â  Â  '',
Â  Â  Â  Â  Â  'hÃ¤r Ã¤r de senaste 5 frÃ¥gorna och svaren:'
Â  Â  Â  Â  ];
Â  Â  Â  Â  const recent = messageHistory.slice(-10); // Ta de senaste 10 meddelandena (5 par)
Â  Â  Â  Â  for (let i = 0; i < recent.length; i += 2) {
Â  Â  Â  Â  Â  const q = recent[i];
Â  Â  Â  Â  Â  const a = recent[i+1];
Â  Â  Â  Â  Â  if (q && a) {
Â  Â  Â  Â  Â  Â  bodyLines.push('', `frÃ¥ga: ${q.content}`, `svar: ${a.content}`);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  bodyLines.push('', 'vÃ¤nligen,', '[namn]', '[telefon]', '[epost]');
Â  Â  Â  Â  const body = bodyLines.join('\n');

Â  Â  Â  Â  const mailLink = createMailLink(subject, body);
Â  Â  Â  Â  const btn = document.createElement('a');
Â  Â  Â  Â  btn.href = mailLink;
Â  Â  Â  Â  btn.textContent = 'skicka e-post till hsb';
Â  Â  Â  Â  btn.className = 'link-button';
Â  Â  Â  Â  btn.target = '_blank';
Â  Â  Â  Â  document.getElementById('messages').appendChild(btn);
Â  Â  Â  }

Â  Â  Â  const clean = txt => txt
Â  Â  Â  Â  .replace(/\b[A-ZÃ…Ã„Ã–][a-zÃ¥Ã¤Ã¶]+\s[A-ZÃ…Ã„Ã–][a-zÃ¥Ã¤Ã¶]+\b/g,'[namn]')
Â  Â  Â  Â  .replace(/[0-9]{6}-[0-9]{4}/g,'[personnummer]')
Â  Â  Â  Â  .replace(/\b\d{10}\b/g,'[telefonnummer]')
Â  Â  Â  Â  .replace(/\b\w+@[^\s]+\b/g,'[epost]')
Â  Â  Â  Â  .replace(/\d{3}\s?\d{2}\s?\d{2}/g,'[postnummer]')
Â  Â  Â  Â  .replace(/\d{2,4}\s?[A-Za-zÃ…Ã„Ã–Ã¥Ã¤Ã¶]{2,}/g,'[adress]');

      // Logga frÃ¥ga/svar-paret som tidigare, inkludera clientTimestamp
Â  Â  Â  if (window.saveChatLog) {
Â  Â  Â  Â  window.saveChatLog(conversationId, clean(message), clean(response), aiResponseClientTimestamp);
Â  Â  Â  }
Â  Â  }

Â  Â  async function loadContextData(userInput) {
Â  Â  Â  const ln = userInput.toLowerCase();
Â  Â  Â  let ctx = [];
Â  Â  Â  for (const [file, data] of cachedContextData) {
Â  Â  Â  Â  const keys = [
Â  Â  Â  Â  Â  ...(data.tags || []),
Â  Â  Â  Â  Â  ...((data.delar || []).flatMap(d => d.nyckelord || []))
Â  Â  Â  Â  ].map(k => k.toLowerCase());
Â  Â  Â  Â  if (keys.some(k => ln.includes(k))) {
Â  Â  Â  Â  Â  ctx.push({ fil: file, innehall: data });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return ctx;
Â  Â  }

    // Modifierad typeMessage fÃ¶r att acceptera clientTimestamp och hantera rating-UI efter skrivning
Â  Â  function typeMessage(text, sender, extraClass='', aiMessageClientTimestamp = null) {
Â  Â  Â  const messages = document.getElementById('messages');
Â  Â  Â  // Hitta den senast tillagda message-container (den som skapades i addMessage)
        const messageContainers = messages.querySelectorAll('.message-container');
        const containerDiv = messageContainers[messageContainers.length - 1];

Â  Â  Â  const messageDiv = containerDiv.querySelector('.message'); // HÃ¤mta meddelande-diven inuti containern

Â  Â  Â  if (sender === 'bot') {
Â  Â  Â  Â  let i = 0;
Â  Â  Â  Â  const chunkSize = 10;
Â  Â  Â  Â  // AnvÃ¤nd innerHTML fÃ¶r att tillÃ¥ta rendering av fetstil (strong-taggar)
Â  Â  Â  Â  function type() {
Â  Â  Â  Â  Â  if (i < text.length) {
              // Se till att vi inte bryter mitt i en HTML-tagg om texten innehÃ¥ller dem
              let nextChunk = text.substring(0, i + chunkSize);
              let nextChar = text[i + chunkSize];

              if (nextChar === '<' && text.substring(i + chunkSize, i + chunkSize + 7) !== '</strong>') {
                   // Om nÃ¤sta tecken Ã¤r start pÃ¥ en tagg, fÃ¶rsÃ¶k inkludera hela taggen
                   let tagEnd = text.indexOf('>', i + chunkSize);
                   if (tagEnd !== -1) {
                       nextChunk = text.substring(0, tagEnd + 1);
                       i = tagEnd + 1;
                   } else {
                       // Om taggen inte avslutas, fortsÃ¤tt som vanligt, det kan bli fel rendering
                       i += chunkSize;
                   }
              } else {
                 i += chunkSize;
              }

Â  Â  Â  Â  Â  Â  div.innerHTML = nextChunk;
Â  Â  Â  Â  Â  Â  messages.scrollTop = messages.scrollHeight;
Â  Â  Â  Â  Â  Â  setTimeout(type, 30); // Justera hastigheten hÃ¤r (30ms)
Â  Â  Â  Â  Â  } else {
              // NÃ¤r meddelandet Ã¤r fullstÃ¤ndigt, se till att HTML renderas korrekt
              messageDiv.innerHTML = text;

              // NYTT: Visa rating-ikonerna efter att meddelandet Ã¤r fÃ¤rdigskrivet
              const ratingDiv = containerDiv.querySelector('.message-rating');
              if(ratingDiv) {
                 ratingDiv.style.opacity = 1;
              }

              // Rulla eventuellt ner igen efter att ikonerna visas
               messages.scrollTop = messages.scrollHeight;
          }
Â  Â  Â  Â  }
Â  Â  Â  Â  type();
Â  Â  Â  } else {
Â  Â  Â  Â  messageDiv.textContent = text; // AnvÃ¤nd textContent fÃ¶r anvÃ¤ndarmeddelanden
Â  Â  Â  Â  messages.scrollTop = messages.scrollHeight;
Â  Â  Â  }
Â  Â  Â  // Returnerar inget specifikt hÃ¤r, hanteringen sker via DOM-manipulation
Â  Â  }


Â  Â  async function getAIResponse(userInput, contextData = []) {
Â  Â  Â  try {
Â  Â  Â  Â  const controller = new AbortController();
Â  Â  Â  Â  const timeoutId = setTimeout(() => controller.abort(), 20000); // Ã–kad timeout till 20s
Â  Â  Â  Â  const step2 = ["vattenlÃ¤cka", "Ã¥rsredovisning", "underhÃ¥llsplan"];
Â  Â  Â  Â  const clar = ["hiss", "trasig", "problem"];
Â  Â  Â  Â  const li = userInput.toLowerCase();
Â  Â  Â  Â  let ap = "";
Â  Â  Â  Â  if (step2.some(k => li.includes(k))) ap = "formatera svaret som en numrerad lista med tydliga steg.";
Â  Â  Â  Â  else if (clar.some(k => li.includes(k))) ap = "stÃ¤ll en fÃ¶ljdfrÃ¥ga fÃ¶r att fÃ¶rtydliga.";
Â  Â  Â  Â  const response = await fetch("/.netlify/functions/styrelsesupport-gpt", {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  conversationId,
Â  Â  Â  Â  Â  Â  messages: [
Â  Â  Â  Â  Â  Â  Â  { role: "system", content: systemPrompt + `\n${ap}` },
Â  Â  Â  Â  Â  Â  Â  // Inkludera senaste meddelandena i historiken fÃ¶r kontext
               ...messageHistory.slice(-8), // Ta de senaste 8 meddelandena (4 par)
Â  Â  Â  Â  Â  Â  Â  { role: "user", content: userInput },
Â  Â  Â  Â  Â  Â  Â  { role: "system", content: `databas trÃ¤ffar:\n${JSON.stringify(contextData).slice(0, 4000)}` } // Klipp kontextdata om fÃ¶r stor
Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  signal: controller.signal
Â  Â  Â  Â  });
Â  Â  Â  Â  clearTimeout(timeoutId);
Â  Â  Â  Â  const js = await response.json();
Â  Â  Â  Â  return js.choices?.[0]?.message?.content || "NÃ¥got gick fel i AI-anropet.";
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Fel vid AI-anrop:", err);
Â  Â  Â  Â  if (err.name === 'AbortError') {
Â  Â  Â  Â  Â  showError("AI-anropet tog fÃ¶r lÃ¥ng tid och avbrÃ¶ts. FÃ¶rsÃ¶k igen.");
Â  Â  Â  Â  Â  return "Svaret tog fÃ¶r lÃ¥ng tid att generera, fÃ¶rsÃ¶k igen.";
Â  Â  Â  Â  }
Â  Â  Â  Â  showError("Kunde inte hÃ¤mta svar. FÃ¶rsÃ¶k igen senare.");
Â  Â  Â  Â  return "NÃ¥got gick fel, fÃ¶rsÃ¶k senare.";
Â  Â  Â  }
Â  Â  }

    // NY HÃ¤ndelselyssnare fÃ¶r klick pÃ¥ rating-ikonerna (anvÃ¤nder Event Delegation)
    document.getElementById('messages').addEventListener('click', (e) => {
        const icon = e.target.closest('.rating-icon');
        if (!icon || icon.classList.contains('disabled')) return; // Ignorera klick om det inte Ã¤r en ikon eller om den Ã¤r inaktiverad

        const rating = icon.dataset.rating; // 'up' eller 'down'
        const ratingDiv = icon.parentElement;
        const messageContainer = ratingDiv.parentElement; // HÃ¤mta containern

        const aiMessageClientTimestamp = messageContainer.dataset.aiTimestamp;
        const currentConversationId = messageContainer.dataset.conversationId;


        if (currentConversationId && aiMessageClientTimestamp && rating) {
            // Spara betyget i Firestore
            window.saveMessageRating(currentConversationId, parseInt(aiMessageClientTimestamp), rating);

            // Visuell feedback: markera den valda ikonen och inaktivera bÃ¥da
            ratingDiv.querySelectorAll('.rating-icon').forEach(i => {
                i.classList.remove('selected', 'up', 'down'); // Ta bort tidigare markeringar
                i.classList.add('disabled'); // Inaktivera alla ikoner i denna uppsÃ¤ttning
            });
            icon.classList.add('selected', rating); // Markera den klickade ikonen

             // Valfritt: LÃ¤gg till en liten text bredvid ikonerna, t.ex. "Tack!"
             // Om du lÃ¤gger till text, behÃ¶ver du hantera det i addMessage och hÃ¤r.
             // Exempel: ratingDiv.innerHTML += '<span style="font-size: 12px; margin-left: 5px;">Tack!</span>';
        } else {
            console.error("Kunde inte hitta nÃ¶dvÃ¤ndig data fÃ¶r att spara betyg.");
        }
    });


Â  </script>
</body>
</html>
