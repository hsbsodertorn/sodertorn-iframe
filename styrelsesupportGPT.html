<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HSB Styrelsesupport GPT</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: white;
    }

    #wrapper {
      height: 100%;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
      border: 2px solid #00558c;
      border-radius: 16px;
      overflow: hidden;
    }

    #chatbox {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    #messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: white;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 75%;
      padding: 12px 16px;
      margin-bottom: 12px;
      border-radius: 20px;
      white-space: pre-line;
      word-break: break-word;
      font-size: 16px;
      line-height: 1.4;
      display: inline-block;
    }

    .user {
      align-self: flex-end;
      background-color: #f7f7f8;
      color: #000;
      border-radius: 18px;
    }

    .bot {
      align-self: flex-start;
      background: none;
      color: #000;
      padding: 0;
    }

    #inputArea {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #e0e0e0;
      gap: 12px;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.04);
    }

    textarea {
      flex: 1;
      min-height: 48px;
      max-height: 200px;
      padding: 14px 20px;
      border-radius: 24px;
      border: 1px solid #ccc;
      font-size: 16px;
      resize: none;
      overflow: hidden;
      line-height: 1.4;
      font-family: sans-serif;
    }

    textarea:focus {
      border: 1px solid #00558c;
      outline: none;
    }

    button {
      background: #00558c;
      color: white;
      border: none;
      border-radius: 24px;
      padding: 14px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
    }

    button:hover {
      background: #004070;
    }

    #fileUpload {
      font-size: 14px;
      color: #00558c;
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <div id="chatbox">
      <div id="messages">
        <div class="message bot">Hej! V칛lkommen till Styrelsesupport GPT 游뱄 Vad vill du ha hj칛lp med idag?</div>
      </div>
      <div id="inputArea">
        <textarea id="userInput" placeholder="Skriv din fr친ga h칛r..." oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
        <input type="file" id="fileUpload" accept=".pdf,.doc,.docx,.txt" onchange="handleFileUpload(event)">
        <button onclick="sendMessage()">Skicka</button>
      </div>
    </div>
  </div>

  <script>
    const conversationId = crypto.randomUUID();
    const messageHistory = [];

    const disclaimerText = `\n---\n*Denna information fr친n Styrelsesupport GPT 칛r v칛gledande och b칬r granskas kritiskt. Vi tar inget ansvar f칬r svarens riktighet. Ladda inte upp k칛nslig information som kan bryta mot GDPR. Kontakta HSB S칬dert칬rn p친 08-608 68 00 eller info.sodertorn@hsb.se vid fr친gor.*`;

    const systemPrompt = `Styrelsesupport 칛r en digital assistent utvecklad av HSB S칬dert칬rn f칬r att st칬dja och st칛rka styrelser i bostadsr칛ttsf칬reningar. ${disclaimerText}`;

    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight + 2) + 'px';
    }

    function handleKey(event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function addMessage(text, sender) {
      const messages = document.getElementById("messages");
      const div = document.createElement("div");
      div.className = "message " + sender;
      div.innerHTML = convertLinks(text);
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    function convertLinks(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, function(url) {
        return `<a href="${url}" target="_blank">${url}</a>`;
      });
    }

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const message = input.value.trim();
      if (!message) return;

      addMessage(message, "user");
      input.value = "";
      autoResize(input);
      messageHistory.push({ role: "user", content: message });

      const response = await getAIResponse(message);
      typeMessage(response, "bot");
      messageHistory.push({ role: "assistant", content: response });
    }

    function typeMessage(text, sender) {
      const messages = document.getElementById("messages");
      const div = document.createElement("div");
      div.className = "message " + sender;
      messages.appendChild(div);

      let i = 0;
      function typeChar() {
        if (i < text.length) {
          div.innerHTML = convertLinks(text.substring(0, ++i));
          messages.scrollTop = messages.scrollHeight;
          setTimeout(typeChar, 12);
        }
      }
      typeChar();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        addMessage(`游늹 ${file.name}`, "user");
      }
    }

    async function getAIResponse(userInput) {
      try {
        const aiRes = await fetch("/.netlify/functions/styrelsesupport-gpt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages: [
              { role: "system", content: systemPrompt },
              ...messageHistory,
              { role: "user", content: userInput }
            ]
          })
        });

        const aiJson = await aiRes.json();
        const gptSvar = aiJson.choices?.[0]?.message?.content;
        return gptSvar || "Jag f칬rs칬kte svara via AI men n친got gick fel. Kontakta HSB S칬dert칬rn f칬r personlig hj칛lp.";
      } catch (error) {
        console.error("Fel vid AI-anrop:", error);
        return "Jag f칬rs칬kte s칬ka med AI men n친got gick fel. F칬rs칬k igen eller kontakta kundservice.";
      }
    }
  </script>
</body>
</html>
