<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HSB Styrelsesupport GPT</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: white;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: sans-serif;
    }

    #wrapper {
      width: 100%;
      height: 100%;
      border: 2px solid #00558c;
      border-radius: 16px;
      overflow: auto; /* Nu kan hela f칬nstret scrolla vid behov */
      display: flex;
      flex-direction: column;
    }

    #chatbox {
      display: flex;
      flex-direction: column;
      min-height: 100%;
      background: white;
    }

    #messages {
      flex: 1;
      padding: 16px;
      background: white;
    }

    .message {
      margin-bottom: 12px;
      white-space: pre-line;
      word-break: break-word;
    }

    .user { text-align: right; color: #00558c; }
    .bot { text-align: left; color: #333; }
    .bot a { color: #00558c; text-decoration: underline; }

    #inputArea {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #e0e0e0;
      gap: 12px;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.04);
    }

    textarea {
      flex: 1;
      min-width: 0;
      min-height: 48px;
      max-height: 200px;
      padding: 14px 20px;
      border-radius: 24px;
      border: 1px solid #ccc;
      font-size: 16px;
      line-height: 1.4;
      resize: none;
      overflow: hidden;
      font-family: sans-serif;
    }

    textarea:focus {
      border: 1px solid #00558c;
      outline: none;
    }

    button {
      background: #00558c;
      color: white;
      border: none;
      border-radius: 24px;
      padding: 14px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
    }

    button:hover {
      background: #004070;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "DIN_FIREBASE_API_KEY",
      authDomain: "hsbsodertorn-1e7a5.firebaseapp.com",
      projectId: "hsbsodertorn-1e7a5",
      storageBucket: "hsbsodertorn-1e7a5.appspot.com",
      messagingSenderId: "34372808211",
      appId: "1:34372808211:web:85e0c908917ff232ce59e6",
      measurementId: "G-LTWGETNT98"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.saveChatLog = async (conversationId, fraga, svar) => {
      try {
        await addDoc(collection(db, "chattlogg"), {
          conversationId,
          fraga,
          svar,
          tid: serverTimestamp()
        });
      } catch (err) {
        console.error("Fel vid loggning i Firebase:", err);
      }
    };
  </script>
</head>
<body>
  <div id="wrapper">
    <div id="chatbox">
      <div id="messages">
        <div class="message bot">Hej! V칛lkommen till Styrelsesupport GPT 游뱄 Vad vill du ha hj칛lp med idag?</div>
      </div>
      <div id="inputArea">
        <textarea id="userInput" placeholder="Skriv din fr친ga h칛r..." oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
        <button onclick="sendMessage()">Skicka</button>
      </div>
    </div>
  </div>

  <script>
    const conversationId = crypto.randomUUID();
    const messageHistory = [];

    const disclaimerText = `
---
*Denna information fr친n Styrelsesupport GPT 칛r v칛gledande och b칬r granskas kritiskt. Vi tar inget ansvar f칬r svarens riktighet. Ladda inte upp k칛nslig information som kan bryta mot GDPR. Kontakta HSB S칬dert칬rn p친 08-608 68 00 eller info.sodertorn@hsb.se vid fr친gor.*`;

    const systemPrompt = `
Styrelsesupport 칛r en digital assistent utvecklad av HSB S칬dert칬rn f칬r att st칬dja och st칛rka styrelser i bostadsr칛ttsf칬reningar...${disclaimerText}`;

    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight + 2) + 'px';
    }

    function handleKey(event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function tvattaText(text) {
      return text
        .replace(/\b[A-Z칀츿칐][a-z친칛칬]+\s[A-Z칀츿칐][a-z친칛칬]+\b/g, "[namn]")
        .replace(/[0-9]{6}-[0-9]{4}/g, "[personnummer]")
        .replace(/\b\d{10}\b/g, "[telefonnummer]")
        .replace(/\b\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}\b/g, "[epost]")
        .replace(/\d{3}\s?\d{2}\s?\d{2}/g, "[postnummer]")
        .replace(/\d{2,4}\s?[A-Za-z칀츿칐a-z친칛칬]{2,}/g, "[adress]");
    }

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const message = input.value.trim();
      if (!message) return;

      addMessage(message, "user");
      input.value = "";
      autoResize(input);
      messageHistory.push({ role: "user", content: message });

      const responseRaw = await getAIResponse(message);
      const response = cleanResponse(responseRaw);

      messageHistory.push({ role: "assistant", content: response });
      typeMessage(response, "bot");

      const tvattadFraga = tvattaText(message);
      const tvattatSvar = tvattaText(response);

      if (window.saveChatLog) {
        window.saveChatLog(conversationId, tvattadFraga, tvattatSvar);
      }
    }

    function cleanResponse(text) {
      return text.replace(disclaimerText, '').trim();
    }

    function addMessage(text, sender) {
      const messages = document.getElementById("messages");
      const div = document.createElement("div");
      div.className = "message " + sender;
      div.innerHTML = convertLinks(text);
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function typeMessage(text, sender) {
      const messages = document.getElementById("messages");
      const div = document.createElement("div");
      div.className = "message " + sender;
      messages.appendChild(div);

      let i = 0;
      function typeChar() {
        if (i < text.length) {
          div.innerHTML = convertLinks(text.substring(0, ++i));
          messages.scrollTop = messages.scrollHeight;
          setTimeout(typeChar, 12);
        }
      }
      typeChar();
    }

    function convertLinks(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, function(url) {
        return `<a href="${url}" target="_blank">${url}</a>`;
      });
    }

    async function getAIResponse(userInput) {
      const dataFiles = ["forvaltning.json", "medlembrf.json", "medlemprivatperson.json", "bospar.json", "storingar.json"];
      let sammanfattadData = "";

      for (const file of dataFiles) {
        try {
          const res = await fetch(`data/${file}`);
          const data = await res.json();

          if (data.delar && Array.isArray(data.delar)) {
            const relevanta = data.delar.filter(d =>
              d.nyckelord?.some(n => userInput.toLowerCase().includes(n.toLowerCase()))
            );
            for (const r of relevanta) {
              sammanfattadData += `\n- ${r.titel}: ${r.beskrivning}`;
            }
          }
        } catch (e) {
          console.warn("Fel vid laddning av databas:", file);
        }
      }

      try {
        const aiRes = await fetch("/.netlify/functions/styrelsesupport-gpt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages: [
              { role: "system", content: systemPrompt + "\nIntern databas:\n" + sammanfattadData },
              ...messageHistory.filter(m => m.role !== "system"),
              { role: "user", content: userInput }
            ]
          })
        });

        const aiJson = await aiRes.json();
        const gptSvar = aiJson.choices?.[0]?.message?.content;

        if (gptSvar) return gptSvar;
        return "Jag f칬rs칬kte svara via AI men n친got gick fel. Kontakta HSB S칬dert칬rn f칬r personlig hj칛lp.";

      } catch (error) {
        console.error("Fel vid AI-anrop:", error);
        return "Jag f칬rs칬kte s칬ka i v친r databas och med AI men n친got gick fel. F칬rs칬k igen eller kontakta kundservice.";
      }
    }
  </script>
</body>
</html>
