<!DOCTYPE html>
<html lang="sv">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Hyreschatten</title>
Â  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
Â  Â  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

Â  Â  // HÃ¥rdkodad Firebase-konfiguration - ersÃ¤tt "DIN_FIREBASE_API_KEY" med din riktiga API-nyckel
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "DIN_FIREBASE_API_KEY", // <--- VIKTIGT: ErsÃ¤tt med din egen Firebase API-nyckel
Â  Â  Â  authDomain: "hsbsodertorn-1e7a5.firebaseapp.com",
Â  Â  Â  projectId: "hsbsodertorn-1e7a5",
Â  Â  Â  storageBucket: "hsbsodertorn-1e7a5.appspot.com",
Â  Â  Â  messagingSenderId: "34372808211",
Â  Â  Â  appId: "1:34372808211:web:85e0c908917ff232ce59e6",
Â  Â  Â  measurementId: "G-LTWGETNT98"
Â  Â  };

Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getFirestore(app);

Â  Â  // KÃ¶ fÃ¶r att hantera loggning vid tillfÃ¤lliga fel
Â  Â  const logQueue = [];
Â  Â  window.saveChatLog = async (conversationId, fraga, svar) => {
Â  Â  Â  const logEntry = {
Â  Â  Â  Â  conversationId,
Â  Â  Â  Â  fraga,
Â  Â  Â  Â  svar,
Â  Â  Â  Â  tid: serverTimestamp()
Â  Â  Â  };
Â  Â  Â  logQueue.push(logEntry);
Â  Â  Â  while (logQueue.length > 0) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // Ã„ndrat till en ny samling fÃ¶r hyreschatten
Â  Â  Â  Â  Â  await addDoc(collection(db, "hyreschattlogg"), logQueue[0]);
Â  Â  Â  Â  Â  logQueue.shift();
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error("Fel vid loggning i Firebase:", err);
Â  Â  Â  Â  Â  showError("Kunde inte spara chatten. FÃ¶rsÃ¶k igen.");
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  };
Â  </script>

Â  <style>
Â  Â  *, *::before, *::after { box-sizing: border-box; }
Â  Â  html, body {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  height: 100%;
Â  Â  Â  font-family: 'Open Sans', sans-serif;
Â  Â  Â  background: white;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  #wrapper {
Â  Â  Â  height: 100%;
Â  Â  Â  width: 100%;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  background: white;
Â  Â  Â  border: 2px solid #00558c;
Â  Â  Â  border-radius: 16px;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  #chatbox {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  }
Â  Â  #messages {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 12px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  background: white;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â  .message {
Â  Â  Â  max-width: 75%;
Â  Â  Â  padding: 10px 14px;
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  white-space: pre-line;
Â  Â  Â  word-break: break-word;
Â  Â  Â  font-size: 16px;
Â  Â  Â  line-height: 1.4;
Â  Â  Â  display: inline-block;
Â  Â  }
Â  Â  .user {
Â  Â  Â  align-self: flex-end;
Â  Â  Â  background-color: #f7f7f8;
Â  Â  Â  color: #000;
Â  Â  }
Â  Â  .bot {
Â  Â  Â  align-self: flex-start;
Â  Â  Â  background: #e8f0fe;
Â  Â  Â  color: #000;
Â  Â  }
Â  Â  .thinking {
Â  Â  Â  display: inline-flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 4px;
Â  Â  }
Â  Â  .dot {
Â  Â  Â  width: 8px;
Â  Â  Â  height: 8px;
Â  Â  Â  background-color: #888;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  animation: blink 1.4s infinite;
Â  Â  }
Â  Â  .dot:nth-child(2) { animation-delay: 0.2s; }
Â  Â  .dot:nth-child(3) { animation-delay: 0.4s; }
Â  Â  @keyframes blink {
Â  Â  Â  0%, 80%, 100% { opacity: 0; }
Â  Â  Â  40% { opacity: 1; }
Â  Â  }
Â  Â  .link-button {
Â  Â  Â  display: inline;
Â  Â  Â  margin: 0 0 0 8px;
Â  Â  Â  background: #00558c;
Â  Â  Â  color: white;
Â  Â  Â  padding: 6px 12px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  text-decoration: none;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  .link-button:hover { background: #004070; }
Â  Â  .topic-buttons {
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 0.5rem;
Â  Â  Â  padding: 12px 12px 4px;
Â  Â  }
Â  Â  .topic-buttons button {
Â  Â  Â  background-color: white;
Â  Â  Â  border: 1px solid #00558c;
Â  Â  Â  border-radius: 16px;
Â  Â  Â  padding: 6px 12px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  color: #00558c;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background 0.2s, color 0.2s;
Â  Â  }
Â  Â  .topic-buttons button:hover {
Â  Â  Â  background-color: #00558c;
Â  Â  Â  color: white;
Â  Â  }
Â  Â  .topic-buttons button.active {
Â  Â  Â  background-color: #00558c;
Â  Â  Â  color: white;
Â  Â  }
Â  Â  #inputArea {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 12px;
Â  Â  Â  border-top: 1px solid #e0e0e0;
Â  Â  Â  gap: 12px;
Â  Â  }
Â  Â  textarea {
Â  Â  Â  flex: 1;
Â  Â  Â  min-height: 48px;
Â  Â  Â  max-height: 200px;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  border-radius: 24px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  font-size: 16px;
Â  Â  Â  resize: none;
Â  Â  Â  font-family: 'Open Sans', sans-serif;
Â  Â  }
Â  Â  textarea:focus {
Â  Â  Â  border-color: #00558c;
Â  Â  Â  outline: none;
Â  Â  }
Â  Â  #charCount { font-size: 14px; color: #666; }
Â  Â  button {
Â  Â  Â  background: #00558c;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 24px;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  button:hover { background: #004070; }
Â  Â  .error {
Â  Â  Â  align-self: center;
Â  Â  Â  background: #ffe6e6;
Â  Â  Â  color: #d32f2f;
Â  Â  Â  padding: 8px 16px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  margin-bottom: 12px;
Â  Â  }
Â  Â  .disclaimer {
Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  color: #333;
Â  Â  Â  font-style: italic;
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 0.5rem 1rem;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div id="wrapper">
Â  Â  <div id="chatbox">
Â  Â  Â  <div class="topic-buttons">
Â  Â  Â  Â  <button>ğŸ› ï¸ NÃ¥got Ã¤r trasigt</button>
Â  Â  Â  Â  <button>ğŸ—ï¸ Inflytt & nycklar</button>
Â  Â  Â  Â  <button>ğŸ”‡ StÃ¶rningar</button>
Â  Â  Â  Â  <button>ğŸ’¸ Hyra & betalning</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="messages" aria-live="polite">
Â  Â  Â  Â  <div class="message bot">Hej! VÃ¤lkommen till Hyreschatten ğŸ¤– Vad vill du ha hjÃ¤lp med idag?</div>
Â  Â  Â  </div>
Â  Â  Â  <div id="inputArea">
Â  Â  Â  Â  <textarea id="userInput" placeholder="skriv din frÃ¥ga hÃ¤r..." maxlength="1000"
Â  Â  Â  Â  Â  oninput="autoResize(this); updateCharCount(this)" onkeydown="handleKey(event)" aria-label="Skriv din frÃ¥ga"></textarea>
Â  Â  Â  Â  <span id="charCount">0/1000</span>
Â  Â  Â  Â  <button onclick="sendMessage()" aria-label="Skicka frÃ¥ga">skicka</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â  <p class="disclaimer">
Â  Â  Information frÃ¥n Hyreschatten Ã¤r vÃ¤gledande och bÃ¶r granskas kritiskt. Vi tar inget ansvar fÃ¶r svarens riktighet.
Â  </p>

Â  <script>
Â  Â  const conversationId = crypto.randomUUID();
Â  Â  const messageHistory = [];
Â  Â  // Ingen cachedContextData fÃ¶r hyreschatten initialt, om det inte tillkommer
Â  Â  // const cachedContextData = new Map();

Â  Â  const disclaimerText = `
---
*information frÃ¥n hyreschatten Ã¤r vÃ¤gledande och bÃ¶r granskas kritiskt. vi tar inget ansvar fÃ¶r svarens riktighet. ladda inte upp kÃ¤nslig information som kan bryta mot gdpr. kontakta hsb sÃ¶dertÃ¶rn pÃ¥ 08-608 68 00 eller info.sodertorn@hsb.se vid frÃ¥gor.*`;

Â  Â  const baseSystemPrompt = `du Ã¤r hyreschatten â€“ vÃ¥r digitala ai-assistentkollega frÃ¥n hsb sÃ¶dertÃ¶rn. du hjÃ¤lper hyresgÃ¤ster i huddinge, botkyrka, tullinge, nynÃ¤shamn, visby och hemse. ditt uppdrag Ã¤r att ge tydliga, trygga och anvÃ¤ndbara svar som hjÃ¤lper hyresgÃ¤sten.

anvÃ¤nd ett omtÃ¤nksamt, vardagligt sprÃ¥k. undvik facksprÃ¥k. anvÃ¤nd aldrig versaler i hela meningar â€“ skriv alltid med gemener fÃ¶rutom i bÃ¶rjan av meningar och vid egennamn.

jag Ã¤r lite partisk eftersom mina skapare kommer frÃ¥n hsb sÃ¶dertÃ¶rn, men jag lovar att alltid ge dig bÃ¤sta mÃ¶jliga rÃ¥d. hsb sÃ¶dertÃ¶rn â€“ pÃ¥ er sida i varje hyresbeslut.

svara alltid sakligt och kortfattat. anvÃ¤nd punktlistor (max 3 punkter) eller numrerad lista vid steg-fÃ¶r-steg. bÃ¶rja varje punkt med liten bokstav.

vid korta, oklara eller testande frÃ¥gor som "kan du hjÃ¤lpa mig?" â€“ stÃ¤ll en mjuk fÃ¶ljdfrÃ¥ga fÃ¶r att fÃ¶rstÃ¥ behovet. exempel: "absolut, jag hjÃ¤lper gÃ¤rna till â€“ gÃ¤ller det nÃ¥got med din lÃ¤genhet just nu?"

fÃ¶rsÃ¶k tolka och fÃ¶rstÃ¥ Ã¤ven om anvÃ¤ndaren skriver slarvigt, talsprÃ¥kligt eller vÃ¤ldigt kortfattat. ge vÃ¤gledande svar utan att korrigera sprÃ¥k.

anpassa svarets lÃ¤ngd till frÃ¥gans stil. om anvÃ¤ndaren skriver kort â€“ svara kort. om frÃ¥gan Ã¤r Ã¶ppen â€“ fÃ¶reslÃ¥ 2â€“3 Ã¤mnesval.

behÃ¥ll alltid ett vÃ¤nligt, respektfullt och hjÃ¤lpsamt tonlÃ¤ge â€“ Ã¤ven vid slarv, felskrivningar eller testfrÃ¥gor.

om anvÃ¤ndaren frÃ¥gar om andra leverantÃ¶rer eller byte, framhÃ¤v alltid fÃ¶rdelarna med hsb sÃ¶dertÃ¶rn.

${disclaimerText}`;

Â  Â  let systemPrompt = baseSystemPrompt;

Â  Â  // Funktionen loadSkrivregler Ã¤r borttagen dÃ¥ hyreschatten inte har en specifik skrivregler.json
Â  Â  // Funktionen preloadContextData Ã¤r borttagen dÃ¥ hyreschatten inte har externa JSON-data initialt

Â  Â  function showError(message) {
Â  Â  Â  const messages = document.getElementById('messages');
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'message error';
Â  Â  Â  div.textContent = message;
Â  Â  Â  messages.appendChild(div);
Â  Â  Â  messages.scrollTop = messages.scrollHeight;
Â  Â  }

Â  Â  function createMailLink(subject, body) {
Â  Â  Â  const params = new URLSearchParams({ subject, body });
Â  Â  Â  return `mailto:info.sodertorn@hsb.se?${params.toString()}`;
Â  Â  }

Â  Â  function autoResize(textarea) {
Â  Â  Â  textarea.style.height = 'auto';
Â  Â  Â  textarea.style.height = `${textarea.scrollHeight + 2}px`;
Â  Â  }

Â  Â  function updateCharCount(textarea) {
Â  Â  Â  document.getElementById('charCount').textContent = `${textarea.value.length}/1000`;
Â  Â  }

Â  Â  function handleKey(event) {
Â  Â  Â  if (event.key === 'Enter' && !event.shiftKey) {
Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  sendMessage();
Â  Â  Â  }
Â  Â  }

Â  Â  function addMessage(text, sender, extraClass='') {
Â  Â  Â  const messages = document.getElementById('messages');
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = `message ${sender} ${extraClass}`;
Â  Â  Â  if (extraClass === 'thinking') {
Â  Â  Â  Â  div.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
Â  Â  Â  } else if (sender === 'bot' && extraClass !== 'error') {
Â  Â  Â  Â  div.innerHTML = text; // TillÃ¥ter HTML fÃ¶r fetstil
Â  Â  Â  } else {
Â  Â  Â  Â  div.textContent = text;
Â  Â  Â  }
Â  Â  Â  messages.appendChild(div);
Â  Â  Â  messages.scrollTop = messages.scrollHeight;
Â  Â  Â  return div;
Â  Â  }

Â  Â  // LÃ¤gg till enkel regex-lÃ¶sning fÃ¶r fetstil
Â  Â  function renderBold(text) {
Â  Â  Â  return text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
Â  Â  }

Â  Â  // Funktion fÃ¶r att tillÃ¤mpa skrivregler pÃ¥ AI-svar
Â  Â  function applySkrivregler(text) {
Â  Â  Â  // BÃ¶rja meningar med versaler, enstaka ord med gemener
Â  Â  Â  return text.replace(/(^|\.\s+)([a-zÃ¥Ã¤Ã¶])/g, (match, p1, p2) => p1 + p2.toUpperCase());
Â  Â  }

Â  Â  async function sendMessage() {
Â  Â  Â  const input = document.getElementById('userInput');
Â  Â  Â  const message = input.value.trim();
Â  Â  Â  if (!message) return;

Â  Â  Â  addMessage(message, 'user');
Â  Â  Â  input.value = '';
Â  Â  Â  updateCharCount(input);
Â  Â  Â  autoResize(input);

Â  Â  Â  messageHistory.push({ role:'user', content:message });
Â  Â  Â  if (messageHistory.length > 10) messageHistory.shift();

Â  Â  Â  const thinking = addMessage('', 'bot','thinking');
Â  Â  Â  // loadContextData Ã¤r borttagen, sÃ¥ contextData Ã¤r tom
Â  Â  Â  let response = await getAIResponse(message);
Â  Â  Â  thinking.remove();

Â  Â  Â  response = response.replace(/\[fÃ¶ljdfrÃ¥ga\]/gi, '').trim();
Â  Â  Â  response = applySkrivregler(response); // TillÃ¤mpa skrivregler
Â  Â  Â  response = renderBold(response);Â  Â  Â  // Rendera fetstil
Â  Â  Â  typeMessage(response, 'bot');
Â  Â  Â  messageHistory.push({ role:'assistant', content:response });

Â  Â  Â  const key = message.toLowerCase();
Â  Â  Â  if (/\b(Ã¤rende|skicka e-post|mail|kontakta)\b/.test(key)) {
Â  Â  Â  Â  const subject = message.substring(0,50);
Â  Â  Â  Â  let bodyLines = [
Â  Â  Â  Â  Â  'Hej,',
Â  Â  Â  Â  Â  '',
Â  Â  Â  Â  Â  'jag heter [namn] och Ã¤r hyresgÃ¤st pÃ¥ [adress].',
Â  Â  Â  Â  Â  '',
Â  Â  Â  Â  Â  'hÃ¤r Ã¤r de senaste 5 frÃ¥gorna och svaren frÃ¥n Hyreschatten:'
Â  Â  Â  Â  ];
Â  Â  Â  Â  const recent = messageHistory.slice(-10);
Â  Â  Â  Â  for (let i = 0; i < recent.length; i += 2) {
Â  Â  Â  Â  Â  const q = recent[i];
Â  Â  Â  Â  Â  const a = recent[i+1];
Â  Â  Â  Â  Â  if (q && a) {
Â  Â  Â  Â  Â  Â  bodyLines.push('', `frÃ¥ga: ${q.content}`, `svar: ${a.content}`);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  bodyLines.push('', 'vÃ¤nligen,', '[namn]', '[telefon]', '[epost]');
Â  Â  Â  Â  const body = bodyLines.join('\n');

Â  Â  Â  Â  const mailLink = createMailLink(subject, body);
Â  Â  Â  Â  const btn = document.createElement('a');
Â  Â  Â  Â  btn.href = mailLink;
Â  Â  Â  Â  btn.textContent = 'skicka e-post till hsb';
Â  Â  Â  Â  btn.className = 'link-button';
Â  Â  Â  Â  btn.target = '_blank';
Â  Â  Â  Â  btn.setAttribute('aria-label', 'Skicka e-post till HSB SÃ¶dertÃ¶rn');
Â  Â  Â  Â  document.getElementById('messages').appendChild(btn);
Â  Â  Â  }

Â  Â  Â  const clean = txt => txt
Â  Â  Â  Â  .replace(/\b[A-ZÃ…Ã„Ã–][a-zÃ¥Ã¤Ã¶]+\s[A-ZÃ…Ã„Ã–][a-zÃ¥Ã¤Ã¶]+\b/g,'[namn]')
Â  Â  Â  Â  .replace(/[0-9]{6}-[0-9]{4}/g,'[personnummer]')
Â  Â  Â  Â  .replace(/\b\d{10}\b/g,'[telefonnummer]')
Â  Â  Â  Â  .replace(/\b\w+@[^\s]+\b/g,'[epost]')
Â  Â  Â  Â  .replace(/\d{3}\s?\d{2}\s?\d{2}/g,'[postnummer]')
Â  Â  Â  Â  .replace(/\d{2,4}\s?[A-Za-zÃ…Ã„Ã–Ã¥Ã¤Ã¶]{2,}/g,'[adress]');
Â  Â  Â  if (window.saveChatLog) {
Â  Â  Â  Â  window.saveChatLog(conversationId, clean(message), clean(response));
Â  Â  Â  }
Â  Â  }

Â  Â  // loadContextData Ã¤r borttagen, eftersom det inte finns nÃ¥gra externa JSON-filer att ladda fÃ¶r hyreschatten.
Â  Â  // Om du vill lÃ¤gga till kontextdata i framtiden, kan du lÃ¤gga till denna funktion igen.
Â  Â  /*
Â  Â  async function loadContextData(userInput) {
Â  Â  Â  const ln = userInput.toLowerCase();
Â  Â  Â  let ctx = [];
Â  Â  Â  for (const [file, data] of cachedContextData) {
Â  Â  Â  Â  const keys = [
Â  Â  Â  Â  Â  ...(data.tags || []),
Â  Â  Â  Â  Â  ...((data.delar || []).flatMap(d => d.nyckelord || []))
Â  Â  Â  Â  ].map(k => k.toLowerCase());
Â  Â  Â  Â  if (keys.some(k => ln.includes(k))) {
Â  Â  Â  Â  Â  ctx.push({ fil: file, innehall: data });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return ctx;
Â  Â  }
Â  Â  */

Â  Â  function typeMessage(text, sender) {
Â  Â  Â  const messages = document.getElementById('messages');
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = `message ${sender}`;
Â  Â  Â  messages.appendChild(div);
Â  Â  Â  if (sender === 'bot') {
Â  Â  Â  Â  let i = 0;
Â  Â  Â  Â  const chunkSize = 10;
Â  Â  Â  Â  function type() {
Â  Â  Â  Â  Â  if (i < text.length) {
Â  Â  Â  Â  Â  Â  div.innerHTML = text.substring(0, i + chunkSize);
Â  Â  Â  Â  Â  Â  i += chunkSize;
Â  Â  Â  Â  Â  Â  messages.scrollTop = messages.scrollHeight;
Â  Â  Â  Â  Â  Â  setTimeout(type, 50);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  type();
Â  Â  Â  } else {
Â  Â  Â  Â  div.textContent = text;
Â  Â  Â  Â  messages.scrollTop = messages.scrollHeight;
Â  Â  Â  }
Â  Â  }

Â  Â  async function getAIResponse(userInput) { // contextData tas bort som parameter
Â  Â  Â  try {
Â  Â  Â  Â  const controller = new AbortController();
Â  Â  Â  Â  const timeoutId = setTimeout(() => controller.abort(), 10000);
Â  Â  Â  Â  const step2 = ["trasigt", "inflytt", "nycklar", "stÃ¶rningar", "hyra", "betalning"];
Â  Â  Â  Â  const clar = ["hiss", "trasig", "problem"];
Â  Â  Â  Â  const li = userInput.toLowerCase();
Â  Â  Â  Â  let ap = "";
Â  Â  Â  Â  if (step2.some(k => li.includes(k))) ap = "formatera svaret som en numrerad lista med tydliga steg.";
Â  Â  Â  Â  else if (clar.some(k => li.includes(k))) ap = "stÃ¤ll en fÃ¶ljdfrÃ¥ga fÃ¶r att fÃ¶rtydliga.";

Â  Â  Â  Â  const response = await fetch("/.netlify/functions/styrelsesupport-gpt", { // behÃ¥ller samma endpoint fÃ¶r AI-anropet
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  conversationId,
Â  Â  Â  Â  Â  Â  messages: [
Â  Â  Â  Â  Â  Â  Â  { role: "system", content: systemPrompt + `\n${ap}` },
Â  Â  Â  Â  Â  Â  Â  ...messageHistory,
Â  Â  Â  Â  Â  Â  Â  { role: "user", content: userInput }
Â  Â  Â  Â  Â  Â  Â  // Borttagen: { role: "system", content: `databas trÃ¤ffar:\n${JSON.stringify(contextData).slice(0, 4000)}` }
Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  signal: controller.signal
Â  Â  Â  Â  });
Â  Â  Â  Â  clearTimeout(timeoutId);
Â  Â  Â  Â  const js = await response.json();
Â  Â  Â  Â  return js.choices?.[0]?.message?.content || "NÃ¥got gick fel i AI-anropet.";
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Fel vid AI-anrop:", err);
Â  Â  Â  Â  showError("Kunde inte hÃ¤mta svar. FÃ¶rsÃ¶k igen senare.");
Â  Â  Â  Â  return "NÃ¥got gick fel, fÃ¶rsÃ¶k senare.";
Â  Â  Â  }
Â  Â  }

Â  Â  // Befintlig JS-kod fÃ¶r hyreschatten behÃ¥lls
Â  Â  function insertMessage(text) {
Â  Â  Â  const messages = document.getElementById('messages');

Â  Â  Â  // Ta bort tidigare automatiska bot-meddelanden (ej det fÃ¶rsta)
Â  Â  Â  const oldBotMessages = messages.querySelectorAll('.bot:not(:first-of-type):not(.thinking):not(.error)');
Â  Â  Â  oldBotMessages.forEach(msg => msg.remove());

Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'message bot';
Â  Â  Â  div.textContent = text;
Â  Â  Â  messages.appendChild(div);
Â  Â  Â  messages.scrollTop = messages.scrollHeight;
Â  Â  }

Â  Â  window.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  const buttons = document.querySelectorAll('.topic-buttons button');
Â  Â  Â  buttons.forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  buttons.forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  Â  let question = '';
Â  Â  Â  Â  Â  switch (btn.textContent.trim()) {
Â  Â  Â  Â  Â  Â  case 'ğŸ› ï¸ NÃ¥got Ã¤r trasigt':
Â  Â  Â  Â  Â  Â  Â  question = 'vad Ã¤r det som Ã¤r trasigt i din lÃ¤genhet eller i huset?';
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case 'ğŸ—ï¸ Inflytt & nycklar':
Â  Â  Â  Â  Â  Â  Â  question = 'vad vill du veta om inflyttning eller nycklar? gÃ¤ller det nycklar, fÃ¶rrÃ¥d eller port?';
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case 'ğŸ”‡ StÃ¶rningar':
Â  Â  Â  Â  Â  Â  Â  question = 'berÃ¤tta gÃ¤rna mer â€“ vad Ã¤r det som stÃ¶r, och hur ofta hÃ¤nder det?';
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case 'ğŸ’¸ Hyra & betalning':
Â  Â  Â  Â  Â  Â  Â  question = 'vad vill du veta om hyran eller hur du betalar den?';
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  insertMessage(question);
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  });
Â  </script>
</body>
</html>
